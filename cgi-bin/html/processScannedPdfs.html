<html>
<head>
  <!--<link rel="stylesheet" type="text/css" href="grade_a_page.css"> -->
  <title>Virtual Grade</title>
</head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script type="text/javascript">
var userToken = '';
var remoteUser = '';
function init(){
    $("#progressIndicator").html("<img src='../data/indicator.gif'>");
    document.getElementById('semester').onchange = function(){
        populateOptions('department',
                        document.getElementById('semester').value);
        };
    document.getElementById('department').onchange = function(){
        populateOptions('course',
                        document.getElementById('semester').value+'/'+
                        document.getElementById('department').value);
        };
    document.getElementById('course').onchange = function(){
        populateOptions('assignment',
                        document.getElementById('semester').value+'/'+
                        document.getElementById('department').value+'/'+
                        document.getElementById('course').value);
        };
    document.getElementById('assignment').onchange = function(){
        return;
        };
    
    $.post("findAssignments.cgi", null, function (data){
        init.assignmentListing = data;
        console.log(data)
        populateOptions('semester','','2014-fall');
        $("#progressIndicator").html("");
    });
    init.darkScans = false;
}

// function populateOptions(selectId,rootOption,optionChoice){
//     var assignmentListing = init.assignmentListing;
//     // remove all options first
//     var obj=document.getElementById(selectId);
// 
//     while(obj.options.length > 0)             
//         obj.remove(0);
//     for (i=0;i<assignmentListing.length;i++){
//         if (assignmentListing[i][0]==rootOption){ // root == ''
//             values = assignmentListing[i][1]
//             var opt = document.createElement("option");
//             opt.value = "-1";
//             opt.text = "--";
//             obj.appendChild(opt); 
//             for(j=0;j<values.length;j++) {
//                 var opt = document.createElement("option");
//                 opt.value = values[j];
//                 opt.text=values[j];
//                 obj.appendChild(opt);
//             }
//         }
//     }
//     if(typeof(optionChoice)!='undefined') {
//         document.getElementById(selectId).value=optionChoice;
//     }
//     else {
//         document.getElementById(selectId).selectedIndex=0;
//     }
//     document.getElementById(selectId).onchange();    
// }

function populateOptions(selectId,rootOption,optionChoice){
    var assignmentListing = init.assignmentListing;
    // remove all options first
    var obj=document.getElementById(selectId);

    while(obj.options.length > 0)             
        obj.remove(0);
        
    var opt = document.createElement("option");
    opt.value = "-1";
    opt.text = "--";
    obj.appendChild(opt); 

    for (i=0;i<assignmentListing[selectId].length;i++){
                optChoice = assignmentListing[selectId][i];
                if (selectId=='department'){
                        if (!possibleOption('semester',optChoice[0]))
                                continue;
                }
                else if (selectId=='course'){
                        if (!possibleOption('semester',optChoice[0]))
                                continue;
                        if (!possibleOption('department',optChoice[1]))
                                continue;
                }
                else if (selectId=='assignment'){
                        if (!possibleOption('semester',optChoice[0]))
                                continue;
                        if (!possibleOption('department',optChoice[1]))
                                continue;
                        if (!possibleOption('course',optChoice[2]))
                                continue;
                }
                opt = document.createElement("option");
                opt.value = optChoice[optChoice.length-1];
                opt.text=optChoice[optChoice.length-1];
                obj.appendChild(opt);
    }
    
    if(typeof(optionChoice)!='undefined') {
        document.getElementById(selectId).value=optionChoice;
    }
    else {
        document.getElementById(selectId).selectedIndex=0;
    }
    document.getElementById(selectId).onchange();  
 
}

function possibleOption(selectId,optChoice){
        parentObjChoice = document.getElementById(selectId).value;
        if (parentObjChoice != optChoice) return false;
        return true;
}

function s4() {
  return Math.floor((1 + Math.random()) * 0x10000)
             .toString(16)
             .substring(1);
};

function guid4() {
  return s4() + s4() + '-' + s4() + '-' + s4() + '-' +
         s4() + '-' + s4() + s4() + s4();
}

function startScanning(){
    // scan PDFs
    pagesPerStudent = document.getElementById("pagesPerStudent").value;
    if (pagesPerStudent=='') {
    	alert("Please enter the number of pages per student.");
    	return;
    }
    semester=document.getElementById('semester').value;
    department=document.getElementById('department').value;
    course=document.getElementById('course').value;
    assignment=document.getElementById('assignment').value.split(' ')[0];
    
    console.log(department);
    if (semester == -1 || department == -1 || course == -1 || assignment == -1) {
        alert("Please select a semester, department, course, and assignment.");
        return;
    }
    
    // guid for querying status
    $("#progressIndicatorScans").html("<img src='../data/indicator.gif'>");
    startScanning.guid = guid4();
    startScanning.xhr = new XMLHttpRequest();
    var fd = new FormData();
    pdfFolder = document.getElementById('pdfFolder').value;
    if (pdfFolder.indexOf('/', pdfFolder.length - 1) != -1) {
        // remove the slash at end
        pdfFolder.slice(0, - 1);
        console.log("removed slash at end of pdfFolder.");
    }
    fd.append('pdfFolder', pdfFolder);
    fd.append('guid',startScanning.guid);
    fd.append('semester',semester);
    fd.append('department',department);
    fd.append('course',course);
    fd.append('assignment',assignment);
    fd.append('pagesPerStudent',pagesPerStudent);
    fd.append('remoteUser',remoteUser);
    if (init.darkScans) {
        fd.append('darkScans','True'); // if dark scanner is used (not copy room)
    }
    else {
        fd.append('darkScans','False');
    }
    startScanning.xhr.open("POST", "convertScans.cgi",true);
    startScanning.xhr.responseType = 'text';
    console.log("Beginning scans...");
    startScanning.xhr.onload = function(e) {
        if (this.status == 200) {
            console.log('response: '+this.response);
            console.log('complete.');
            $("#progressIndicatorScans").html("");
            clearInterval(startScanning.getStatusTimer);
            // call once more in case there is anything left in the status file
            getStatus();
            jQuery("#scanOutput").append("Done with all scanning."+'<p>')
        }
    };
    startScanning.xhr.send(fd);
    getStatus.linesRead = 0;
    startScanning.getStatusTimer = setInterval(getStatus, 2000);
}

function getStatus(){
    console.log('checking status...');
    $.post( "convertStatus.cgi", {'convertId':startScanning.guid,'linesRead':getStatus.linesRead}, 
                                       function (data){
        data = data.split('\n')
        getStatus.linesRead+=data.length-1
        //console.log(data);
        for (i=0;i<data.length;i++) {
            jQuery("#scanOutput").append(data[i]+'<p>');
        }
        window.scrollTo(0,document.body.scrollHeight);
    });
    
}
function login(){
    $.post("remoteUser.cgi", {}, 
                function (data){
                    console.log(data);
                    login.remoteUser = data['remoteUser'];
                    login.rights= data['rights'];
                    if (data.rights.indexOf('admin')!= -1) {
                        // load setup page
                        window.location = 'loadPage.cgi?userToken=""&page=startAdmin'+
                                    '&remoteUser='+login.remoteUser;
                    }
                    else if (data.rights.indexOf('grader') != -1) {
                        // load grading page
                    }
                    else {
                        alert('Unauthorized User. Please see a faculty member for assistance.');
                    }
            });
}
</script>

<body onload="init()">
    <p style="font-size:20px">
    <b><a href="javascript:login();">Virtual Grade</a></b>
    <p>
    <span id="progressIndicator"></span>
    <p>
    Select Semester:
    <select name="semester" id="semester">
        <span id='semesterOptionSpan'></span>
    </select>
    <p>
    <p>
    Select Department:
    <select name='department' id='department'>
        <span id='semesterOptionSpan'></span>
    </select>
    <p>
    Select Course:
    <select name='course' id='course'>
        <span id='courseOptionSpan'></span>
    </select>
    <p>
    Select Assignment:
    <select name='assignment' id='assignment'>
        <span id='assignmentOptionSpan'></span>
    </select>
    <p>
    Folder with PDF scans of assignment:<input type="text" value="/g/15/2014-fall/grading/tests/test1/" id="pdfFolder" size="50">
    <p>
    Total number of pages per student:<input type="text" id="pagesPerStudent" size="10">
    <p>
    <input type="button" value="Start Scanning Assignment" id="submit" onclick="startScanning()">
    <p>
    <span id='scanOutput'></scan>
    <p>
    <span id="progressIndicatorScans"></span>
</body>
</html>