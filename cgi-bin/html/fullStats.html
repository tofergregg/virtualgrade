<!doctype html>
<html>
<head>
  <link rel="stylesheet" type="text/css" href="html/fullStats.css">
  <title>Virtual Grade</title>
  <meta charset="utf-8">
  <link href="histogram.css" rel="stylesheet" type="text/css">
</head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script type="text/javascript" src="table2CSV.js" > </script>
<script type="text/javascript" src="download.js"> </script>
<script type="text/javascript">
var userToken = '';
var remoteUser = '';
var pagePoints = '';
var semester = '';
var department = '';
var course = '';
var assignment = '';

$(document).ready(function () {
    $('table').each(function () {
        var $table = $(this);

        var $button = $("<button type='button'>");
        $button.text("Export to spreadsheet");
        $button.insertAfter($table);

        $button.click(function () {
            var csv = $table.table2CSV({
                delivery: 'value'
            });
            csv.replace(/&nbsp/g,"");
            window.location.href = 'data:text/csv;charset=UTF-8,' 
            + encodeURIComponent(csv);
        });
   });
});

// sort function from: http://stackoverflow.com/a/8837505/561677
function sortByKey(array, key) {
    return array.sort(function(a, b) {
        var x = a[key]; var y = b[key];
        return ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });
}

function init(){
    $("#progressIndicator").html("<img src='../data/indicator.gif'>");
    if (typeof(pagePoints) != 'object'){
        pagePoints = pagePoints.split(',');
    }
    if (pagePoints[0]=="") { // no points per page
        pagePoints="";
    }
    assignmentPath = semester+'/'+department+'/'+course+'/'+assignment.split(' ')[0]+'/';
    // load info for assignment
    $("#selectedCourse").html('Selected Course: <b>'+
                                semester+'➞'+
                                department+'➞'+
                                course+'➞'+assignment+'</b>')
    $("#remoteUser").html('Grader: <b>'+remoteUser+'</b>');
    // get point values for assignment
    $.post( "getAssignmentInfo.cgi", {'assignment':assignmentPath}, 
                                       function (data){
        init.pointValues = data['points'];
        init.studentIds = data['students'];

        // determine progress
        var ungradedPages = 0;
        var gradedPages = 0;
        init.ungradedPagesList = {}; // will sort by pageNum
        init.gradedPagesList = {}; // will sort by pageNum
        for (i=0;i<init.studentIds.length;i++){
            ungradedPages+=init.studentIds[i][1].length;
            for (unGradedPage=0;unGradedPage<init.studentIds[i][1].length;unGradedPage++){
                var studentId = init.studentIds[i][0];
                var pageNum = init.studentIds[i][1][unGradedPage].replace(/\D/g,''); 
                if (typeof(init.ungradedPagesList[pageNum])==='undefined') {
                    init.ungradedPagesList[pageNum]=[];
                }
                init.ungradedPagesList[pageNum].push(studentId);
                //init.ungradedPagesList.push(studentId:pageNum);
            }
            gradedPages+=init.studentIds[i][2].length;
            for (gradedPage=0;gradedPage<init.studentIds[i][2].length;gradedPage++){
                var studentId = init.studentIds[i][0];
                var pageNum = init.studentIds[i][2][gradedPage].replace(/\D/g,''); 
                //init.gradedPagesList.push([init.studentIds[i][0],pageNum]);
                if (typeof(init.gradedPagesList[pageNum])==='undefined') {
                    init.gradedPagesList[pageNum]=[];
                }
                init.gradedPagesList[pageNum].push(studentId);
                //init.gradedPagesList.push(studentId:pageNum);

            }
        }
        totalPages = gradedPages + ungradedPages;
        var progressPerc = gradedPages / (gradedPages+ungradedPages) * 100;

        init.dataURL = horizontalRule(progressPerc,200,12)

        $("#progress").html('Assignment Progress: '+
                            '<img src='+init.dataURL+'>&nbsp'+
                            progressPerc.toFixed(2)+'% graded ('+
                            gradedPages+'/'+(gradedPages + ungradedPages)+
                            ' pages)');
        findGradedPages();
        if (init.bonusPoints == undefined) {
        	init.bonusPoints = 0;
        }
        $("#bonusPointsSpan").html(init.bonusPoints+")");
        loadBonusPoints();
        
    });
    gradesArePublished(false);
    checkIfStudentPDFs();
}
function setBonusPoints() {
	var points = prompt("Please enter the number of bonus points");
	init.bonusPoints = parseFloat(points);
	updateBonusPointsOnServer(init.bonusPoints);
	init();
}

function updateBonusPointsOnServer(bonusPoints) {
	console.log("Updating bonus points on server...");
	$("#progressIndicator").html("<img src='../data/indicator.gif'>");
	$.post("updateBonusPoints.cgi", {'remoteUser':remoteUser,
				     'dirToChange':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/',
					'bonusPoints':bonusPoints}, 
	function (data){
	    console.log(data);
	    $("#progressIndicator").html("");
	});        
}

function loadBonusPoints() {
	console.log("loading bonus points...");
	$.post("loadBonusPoints.cgi", {'remoteUser':remoteUser,
				     'dirToChange':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/'}, 
	function (data){
	    console.log(data);
	    init.bonusPoints=parseFloat(data);
	    console.log(init.bonusPoints);
	    $("#bonusPointsSpan").html(init.bonusPoints+")");
	});        
}

function findGradedPages(){
    // find pages graded    
    $.post( "findGradedPages.cgi", {'assignment':assignmentPath}, 
                                       function (data){
            makeGradedPagesTable.gradedPages = data.gradesList;

            var tableText=makeGradedPagesTable('studentId',remoteUser);
            $("#pagesTable").html('<p>'+tableText);
            $('.loadPage').click(function(evt){
                var eventInfo = $(evt.target);
                var page = eventInfo.attr('page');
                var studentId = eventInfo.attr('studentId');
                var grade = eventInfo.attr('grade');
                var completeExam = eventInfo.attr('completeExam');
                var gradeMax = eventInfo.attr('gradeMax');

		$("#smallProgress_"+studentId).html("<img src='../data/smallProgress.gif'>");

                console.log('clicked on '+studentId+','+page+','+grade+','+completeExam);
                if (page=='-1') { // full student exam
                    var totalPoints = 0;
                    // total function taken from: http://stackoverflow.com/a/1230235/561677
//                     $.each(init.pointValues,function() {
//                         totalPoints += this;
//                     });
			console.log("gm:"+gradeMax+","+init.bonusPoints);
                    studentCompleteExam(studentId,grade,gradeMax-init.bonusPoints,completeExam,true);
                }
                else {
                    if (grade=='--') grade='-1';
                    if (gradeMax=='--') gradeMax='-1';
                    loadAPage(page,studentId,grade,gradeMax);
                }
            });
            $("#progressIndicator").html("");

    });
}
function horizontalRule(percGreen,lineWidth,lineHeight){
    // create graphical representation of the progress
    var buffer = document.createElement('canvas');
    buffer.width=lineWidth;
    buffer.height=lineHeight;

    var context = buffer.getContext('2d');
    // graded
    context.beginPath();
    context.rect(0, 0, percGreen*lineWidth/100.0, 12);
    context.fillStyle = 'green';
    context.fill();
    // ungraded
    context.beginPath();
    context.rect(percGreen*lineWidth/100.0, 0, 200, 12);
    context.fillStyle = 'red';
    context.fill();
    
    return(buffer.toDataURL());
}

function unlockPage(student,pageToUnlock){
    $.post("unlockPage.cgi", {'remoteUser':remoteUser,'studentToLock':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/'
                                                    +student+'/',
                                    'pageToLock':pageToUnlock}, 
                                    function (data){
                console.log(data);
                init();
            });                                                 
}
function ungradedPages(singlePage,studentId){
    if(typeof(singlePage)==='undefined') singlePage = 0; // all pages
    if(typeof(studentId)==='undefined') studentId='all';
    // make a list of all the ungraded pages
    var ungradedList = []
    for (i=0;i<init.studentIds.length;i++){
        //console.log(studentId+','+init.studentIds[i][0]+','+(studentId != 'all')+','+(studentId != init.studentIds[i][0]));
        if ( (studentId != 'all') && (studentId != init.studentIds[i][0]) ) continue;
        for(page=0;page<init.studentIds[i][1].length;page++){
            // only include the page requested (or all if singlePage==0)
            if (singlePage > 0){
                if (init.studentIds[i][1][page].replace(/\D/g,'') != singlePage) continue;
            }
            var skipLockedItem=false;
            for (lockItem=0;lockItem<init.lockedList.length;lockItem++){
                // check if choice is in the locked list
                if ( ( (init.studentIds[i][0]==init.lockedList[lockItem][0]) &&
                        (init.lockedList[lockItem][1].indexOf(init.studentIds[i][1][page])==0)
                       ) ) {
                    skipLockedItem=true;
                }
            }
            if (!skipLockedItem) ungradedList.push([init.studentIds[i][0],init.studentIds[i][1][page]]);
        }
    }
    return ungradedList;
}

function loadAPage(pageNum,studentId,grade,gradeMax){
    // grade should be -1 for an ungraded page
    // lock and deliver page choice
    //lock
    if (grade != '-1') {
        gradedPage='page'+pageNum+'_graded.png';
    }
    else {
        gradedPage='page'+pageNum+'.png';
    }
    console.log('locking');
    $.post("lockPage.cgi", {'remoteUser':remoteUser,'studentToLock':semester+'/'+department+'/'+
                                            course+'/'+assignment.split(' ')[0]+'/'
                                            +studentId+'/',
                            'pageToLock':'page'+pageNum+'.png'},
                            function (data){
        console.log(data);
        console.log("here");
        if (data.toLowerCase().indexOf('failed') != -1) {
            alert('The page you clicked on is locked.\n'+
                    'Please go to the previous page to unlock.');
        }
        else {
        //console.log(gradeMax);
        $("#pageLoadPage").val('gradeOnePage');
        $("#userTokenLoadPage").val(userToken);
        $("#remoteUserLoadPage").val(remoteUser);
        $("#pageToLoadLoadPage").val(semester+'/'+
                                department+'/'+
                                course+'/'+
                                assignment.split(' ')[0]+'/'+
                                studentId+'/'+
                                gradedPage);
        $("#pagePointsLoadPage").val(init.pointValues.toString());
        $("#pageNumLoadPage").val(pageNum);
        $("#semesterLoadPage").val(semester);
        $("#departmentLoadPage").val(department);
        $("#courseLoadPage").val(course);
        $("#assignmentLoadPage").val(assignment);
        $("#nextPageTypeLoadPage").val(studentId);
        $("#currentGradeLoadPage").val(grade);
        $("#gradeMaxLoadPage").val(gradeMax);
        $("#loadPageForm").submit();
        
        }
        
    });   
}
function makeGradedPagesTable(byKey,byUserId){
    sortByKey(makeGradedPagesTable.gradedPages,byKey);
    var tableText = "<table border='1'>\n<tbody>\n" // first part of table
    tdText = '<td valign="top" style="padding-left: 10px; padding-right: 10px;">';

    // table headers
    tableText+="<tr>\n"+tdText+"<b>Student ("+init.studentIds.length+" total)</b></td>\n";
    tableText+=tdText+"<b>Overall&nbsp&nbsp</b></td>\n";
    // get max page count to fill out table (this is for non-standard page counts)
    var maxPageCount = 0;
    for (i=0;i<init.studentIds.length;i++) {
        studentPageCount = init.studentIds[i][1].length+init.studentIds[i][2].length;
        if (studentPageCount > maxPageCount) maxPageCount = studentPageCount;
    }
    for (pageNum=0;pageNum<maxPageCount;pageNum++) {
            tableText+=tdText+'<b>Page '+(pageNum+1)+
                    '<br><input type="button" id="ptsChange_'+pageNum+
                    '" onclick="changePts('+(pageNum+1)+')" '
                    +'value="Change Pts">'+'</b></td>';
    }
    
    if (pagePoints.length > 0) {
        tableText+="<tr>\n"+tdText+"<b>Points per page</b></td>\n";
    }
    else {
        tableText+="<tr>\n"+tdText+"<b>Total Points</b></td>\n";
    }
    tableText+=tdText+"<b>overallpoints</b></td>\n";
    var totalPoints=0;
    if (pagePoints.length > 0) {
        for (pageNum=0;pageNum<maxPageCount;pageNum++) {
            pointsForPage = parseInt(pagePoints[pageNum]);
            totalPoints+=pointsForPage;
            tableText+=tdText+'<b>'+pagePoints[pageNum];
            if (pointsForPage==0) {
                tableText+='<input type="button" id="pageChange_' +pageNum+'" pageNum="'+(pageNum+1) +
                           '" value="Set All" onclick="setAllPageScore('+pageNum+')">'                
            }
            tableText+='</b></td>';
        }
        tableText = tableText.replace("overallpoints",totalPoints-init.bonusPoints);
    }
    else {
        tableText = tableText.replace("overallpoints","--"); // fill this in when all scores complete
    }

    tableText+='<tr>\n'+tdText+'<b>Average</b></td>\n';
    tableText+=tdText+'<b>averageOverall</b>&nbsp <img src="../data/histogram.png"'
                    +' onclick="make_histogram(-1,\''+semester+' '+department+' '
                    +course+' '+assignment+'\')"'
                    +' height="15px" width="15px"></td>\n';
    var totalPoints=0;
    if (pagePoints.length > 0) {
        for (pageNum=0;pageNum<maxPageCount;pageNum++) {
            totalPoints+=parseInt(pagePoints[pageNum]);
            tableText+=tdText+'<b>average'+pageNum
                    +'</b>&nbsp<img src="../data/histogram.png"'
                    +' onclick="make_histogram('
                    +pageNum+",'"
                    +semester+' '+department+' '
                    +course+' '+assignment+'\')"'
                    +' height="15px" width="15px"></td>';
        }
    }
    tableText = tableText.replace("overallpoints",totalPoints-init.bonusPoints);
    // make rows for all students
    makeGradedPagesTable.pageList={};
    var page = 0;
    var allGradesComplete = true;
    var overallAverage={'total':0,'numStudents':0};
    // each array value in pageAverages is a list: {'total','numStudents'}
    var pageAverages=[];
    gradedPage = makeGradedPagesTable.gradedPages[page];
    for (i=0;i<init.studentIds.length;i++) {
        var student = init.studentIds[i][0];
        var studentTotalPages = init.studentIds[i][1].length+init.studentIds[i][2].length;
        tableText+="<tr>\n"+tdText+'<a class="loadPage" style="color:blue" id="'+student+'_page"'+
                                ' studentId="'+student+'"'+
                                ' page="-1"'+
                                ' grade=""'+student+ // for adding the total grade later
                                ' gradeMax=""'+
                                ' completeExam="'+student+'"'+
                                '>'+
                                student+"</a>"+
                                '<input type="button" id="nameChange_' 
                                +student+
                                '" studentName="'
                                +student +
                                '" value="change" onclick="nameChange(this)">'
                                + '<span id="smallProgress_'+student+'"></span>'
                                + '</td>\n'; 
        
        // placeholder for overall score
        tableText+=tdText+"overall"+student+"</td>";
        
        var gradeList = []; // this will be a list of scores
        for (pageNum=0;pageNum<studentTotalPages;pageNum++) {
            gradeList.push({'studentId':student,
                                'grade':'--',
                                'gradeMax':'--',
                                'pageNum':pageNum+1})
            pageAverages.push({'total':0,'numStudents':0});
        }
        while (typeof(gradedPage) != 'undefined' && gradedPage['studentId']===student) {
            //gradeList.push(gradedPage);
            gradeList[gradedPage['pageNum']-1]['grade']=gradedPage['grade'];
            gradeList[gradedPage['pageNum']-1]['gradeMax']=gradedPage['gradeMax'];
            page+=1;   
            if (page >= makeGradedPagesTable.gradedPages.length) break;  
            gradedPage = makeGradedPagesTable.gradedPages[page];
        }

        totalGrade = 0;
        totalMaxPoints = 0;
        gradeComplete=true;
        for (pageNum=0;pageNum<studentTotalPages;pageNum++) {
            if (pagePoints.length > 0) {
                tableText+=tdText+'<a class="loadPage" studentId="'+student+'"'+
                                    ' page="'+(pageNum+1)+'"'+
                                    ' grade="'+gradeList[pageNum]['grade']+'"'+
                                    ' gradeMax="'+gradeList[pageNum]['gradeMax']+'"'+
                                    '>'+gradeList[pageNum]['grade']+"</a></td>\n";
            }
            else {
                tableText+=tdText+'<a class="loadPage" studentId="'+student+'"'+
                                    ' page="'+(pageNum+1)+'"'+
                                    ' grade="'+gradeList[pageNum]['grade']+'"'+
                                    ' gradeMax="'+gradeList[pageNum]['gradeMax']+'"'+
                                    '>'+gradeList[pageNum]['grade']+"/"+
                                    gradeList[pageNum]['gradeMax']+
                                    "</a></td>\n";
            }
            if (gradeList[pageNum]['grade']=='--') {
                gradeComplete=false;
                allGradesComplete=false;
            }
            else {
                totalGrade+=parseFloat(gradeList[pageNum]['grade']);
                totalMaxPoints+=parseInt(gradeList[pageNum]['gradeMax']);
                pageAverages[pageNum]['total']+=parseFloat(gradeList[pageNum]['grade']);
                pageAverages[pageNum]['numStudents']+=1;
            }
        }

        overallAverage['total']+=totalGrade;
        overallAverage['numStudents']+=1;
        
        // replace student overall score with score, red=incomplete, green=complete
        if (pagePoints.length>0) {
            if (gradeComplete) {
                tableText = tableText.replace("overall"+student,"<span style='color:green;'>"+
                                                                totalGrade+"</span>");
                tableText = tableText.replace('completeExam="'+student,'completeExam="complete"');
            }
            else {
                tableText = tableText.replace("overall"+student,"<span style='color:red;'>"+
                                                                totalGrade+"</span>");
                tableText = tableText.replace('completeExam="'+student,'completeExam="incomplete"');
            }
        }
        else { // for assignments that have varying points per page
            if (gradeComplete) {
                tableText = tableText.replace("overall"+student,"<span style='color:green;'>"+
                                                                totalGrade+"/"+
                                                                totalMaxPoints+"</span>");
                tableText = tableText.replace('completeExam="'+student,'completeExam="complete"');
            }
            else {
                tableText = tableText.replace("overall"+student,"<span style='color:red;'>"+
                                                                totalGrade+"/"+
                                                                totalMaxPoints+"</span>");
                tableText = tableText.replace('completeExam="'+student,'completeExam="incomplete"');
            }
        }
        // replace grade text in link for full exam 
        tableText = tableText.replace('grade=""'+student,'grade="'+totalGrade+'"'+
                                                        ' gradeMax="'+totalMaxPoints+'"');
        
        tableText+="</tr>";
    }
    if (allGradesComplete) {
        var overallAvg;
        if (overallAverage['numStudents']>0) {
            overallAvg = overallAverage['total']/overallAverage['numStudents'];
            tableText = tableText.replace("averageOverall","<span style='color:green;'>"+
                                            (overallAvg).toFixed(2)+
                                            "</span>");
        }
        else {
            overallAvg = '--';
            tableText = tableText.replace("averageOverall","<span>"+
                                            (overallAvg)+
                                            "</span>");
        }
    }
    else if (overallAverage['numStudents']==0) {
        tableText = tableText.replace("averageOverall","<span style='color:red;'>"+
                                            '--'+
                                            "</span>");
    }
    else {
        tableText = tableText.replace("averageOverall","<span style='color:red;'>"+
                                            (overallAverage['total']/overallAverage['numStudents']).toFixed(2)+
                                            "</span>");
    }
    // fill in page averages
    for (pageNum=0;pageNum<pagePoints.length;pageNum++) {
        if (typeof(pageAverages[pageNum])!='undefined') {
            if (pageAverages[pageNum]['numStudents']==init.studentIds.length) {
                tableText = tableText.replace("average"+pageNum,"<span style='color:green;'>"+
                                                (pageAverages[pageNum]['total']/pageAverages[pageNum]['numStudents']).toFixed(2)+
                                                "</span>");
            }
            else if (pageAverages[pageNum]['numStudents']==0) {
                tableText = tableText.replace("average"+pageNum,"<span style='color:black;'>"+
                                                '--'+
                                                "</span>");
            }
            else {
            tableText = tableText.replace("average"+pageNum,"<span style='color:red;'>"+
                                            (pageAverages[pageNum]['total']/pageAverages[pageNum]['numStudents']).toFixed(2)+
                                            "</span>");
            }
        }
        else {
            tableText = tableText.replace("average"+pageNum,"<span style='color:black;'>"+
                                                '--'+
                                                "</span>");
        }
    }
    tableText+='</tbody>\n</table>';
    init.tableText = tableText;
    return tableText;
}
function make_histogram(pageNum,title)
{
        console.log("Making historgram for page "+pageNum+".");
        var csv = $("#pagesTable").table2CSV({
                delivery: 'value'
        });
        // parse csv for values
        // starts with row 3
        make_histogram.csv = csv;
        csv = csv.split('\n');
        // no need for the first 3 rows
        csv.shift(); csv.shift(); csv.shift();
        var histArr = [];
        for (var i=0;i<csv.length;i++){
                var row = csv[i].replace(/"/g,"").split(",");
                if (row[pageNum+2]=='--') continue; // don't count ungraded pages
                histArr.push(row[pageNum+2]);
        }
        // put page number on title if necessary
        if (pageNum >= 0) {
                title += ' Page '+(pageNum+1);
        }
        var newWindow = window.open('html/histogram.html');
        newWindow.addEventListener('load', function() {
                newWindow.generateHistogram(histArr,title);
        },true);
}
function changePts(pageNum){
        console.log("Changing points for page "+pageNum);
        var newPoints = prompt("Please enter the new number of points for Page "+pageNum);

        if (newPoints == "" || newPoints == null) {
                return;
        }
        console.log("new points for page "+pageNum+": " +newPoints);
        $.post("changePts.cgi", {'remoteUser':remoteUser,'dirToChange':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/',
                                                    'pageNum':pageNum-1,
                                                    'newPoints':newPoints}, 
                                    function (data){
                console.log(data);
                pagePoints[pageNum-1]=newPoints;
                // reload the page with the correct points.
                // we reload the page because the points are embedded in
                // the URL, and a refresh could revert to original
                fullStats(); // reload page with new values
            });

}

function fullStats(){
        referrer = 'fullStatistics';
        post('loadPage.cgi',{'page':referrer,
                'userToken':userToken,
                'remoteUser':remoteUser,
                'pagePoints':pagePoints,
                'semester':semester,
                'department':department,
                'course':course,
                'assignment':assignment});
}

function setAllPageScore(pageNum){
        // var eventInfo = $(evt.target);
        // var pageNum = eventInfo.attr('pageNum');
        console.log("Setting page " + pageNum + " to 0 for all students.");
        $("#progressIndicator").html("<img src='../data/indicator.gif'>");
        $.post("changeAllToZero.cgi", {'remoteUser':remoteUser,'dirToChange':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/',
                                                    'pageNum':pageNum+1,
                                                    'score':0}, 
                                    function (data){
                                        console.log(data);
                                        init();
                                        $("#progressIndicator").html("");
                                    });
}

function nameChange(sender){
        // var eventInfo = $(evt.target);
        // var student = eventInfo.attr('studentName');
        var student = sender.getAttribute("studentName");
        console.log("Changing name for "+student);
        $("#smallProgress_"+student).html("<img src='../data/smallProgress.gif'>");
        var newName = prompt("Please enter the new studentID (leave blank to delete)");
        if (newName == null) {
                $("#smallProgress_"+student).html("");
                return;
        }
        if (newName=="") {
        	if (!window.confirm("Are you sure you want to delete "+student+"?")) return;
        	newName="...DELETE"; // hack to pass to python (unfortunately)
        }
        console.log("newName:"+newName);
        $.post("changeName.cgi", {'remoteUser':remoteUser,'dirToChange':semester+'/'+department+'/'+
                                                    course+'/'+assignment.split(' ')[0]+'/',
                                                    'studentToChange':student,
                                                    'newName':newName}, 
                                    function (data){
                console.log(data);
                $("#smallProgress_"+student).html("");
                init();
            });
        
}
function getPageStats(){
    if (typeof(getPageStats.showing)==='undefined') getPageStats.showing=false;
    getPageStats.showing = !getPageStats.showing;
    if (getPageStats.showing) {
        getPageStats.pagePercents = [];
        for (i=1;i<init.pointValues.length+1;i++) {
            if (typeof(init.ungradedPagesList[i])==='undefined') {
                getPageStats.pagePercents.push([100,init.gradedPagesList[i].length,init.gradedPagesList[i].length]);
            }
            else {
                if (typeof(init.gradedPagesList[i])==='undefined')
                    getPageStats.pagePercents.push([0,0,init.ungradedPagesList[i].length]);
                else{
                    getPageStats.pagePercents.push([init.gradedPagesList[i].length/(init.gradedPagesList[i].length+init.ungradedPagesList[i].length)*100,
                                                    init.gradedPagesList[i].length,init.gradedPagesList[i].length+init.ungradedPagesList[i].length]);
                }
            }
        }
        for (i=0;i<getPageStats.pagePercents.length;i++){
            var dataURL = horizontalRule(getPageStats.pagePercents[i][0],200,12)
        
            $("#miniPageStatsSpan").append('➢ Page '+(i+1)+':&nbsp<img src='+dataURL+
                    '>&nbsp'+getPageStats.pagePercents[i][0]+'% ('+
                    getPageStats.pagePercents[i][1]+'/'+
                    getPageStats.pagePercents[i][2]+')<br>');
        
        }
        $("#miniPageStatsSpan").append("<br>");
    }
    else {
        $("#miniPageStatsSpan").html("");
    }
}
function studentCompleteExam(studentId,studentScore,totalPoints,completeExam,downloadExam){
    console.log('creating student exam');
    console.log('totalPoints...:'+totalPoints);
    $.post( "constructStudentExam.cgi", {'remoteUser':remoteUser,
                                        'studentDir':semester+'/'+
                                        department+'/'+
                                        course+'/'+
                                        assignment.split(' ')[0]+'/'+
                                        studentId+'/',
                                        'studentScore':studentScore,
                                        'totalPoints':totalPoints,
                                        'completeExam':completeExam
                                        }, 
                                    function (data){
	console.log(data);
	$("#smallProgress_"+studentId).html("");

	if (downloadExam) {
		$("#remoteUserDownloadExam").val(remoteUser);
		$("#studentDirDownloadExam").val(semester+'/'+
					department+'/'+
					course+'/'+
					assignment.split(' ')[0]+'/'+
					studentId+'/');
		$("#downloadStudentExam").submit();
        }
        else { // we are making all PDFs, so we will update the screen
            $("#pdfPagesComplete").append(data+"<br>");
            window.scrollTo(0,document.body.scrollHeight);
        }
    });
}
function createAllPdfs(){ // probably should limit this to admin users
    if (confirm('Are you sure you want to create all PDF exams?\n(this can be time-consuming '+
                'and cannot be halted)')) {
        $("#pdfPagesComplete").html("");
        $("#progressIndicator").html("<img src='../data/indicator.gif'>");

        var totalPoints=0;
        // total function taken from: http://stackoverflow.com/a/1230235/561677
        $.each(init.pointValues,function() {
            totalPoints += this;
        });
        // slow down the process as to not overwhelm the server
        // only request one exam every 2 seconds
        var studentIndex=0;
        
        pdfInterval = setInterval(function(){
        	var studentTestInfo = document.getElementById(init.studentIds[studentIndex][0]+"_page");
            	var studentId = studentTestInfo.getAttribute('studentId');
            	var grade = studentTestInfo.getAttribute('grade');
            	var completeExam = studentTestInfo.getAttribute('completeExam');
            
            	studentCompleteExam(studentId,grade,totalPoints-init.bonusPoints,completeExam,false);
            	console.log(studentId+','+grade+','+(totalPoints-init.bonusPoints)+','+completeExam);
            	studentIndex++;
            	if (studentIndex == init.studentIds.length) clearInterval(pdfInterval);
        },2000);

        // check for complete
        createAllPdfs.getStatusTimer = setInterval(function(){
            console.log('checking status');
            completedPdfs = $("#pdfPagesComplete").html().split('\n').length;
            if (completedPdfs >= init.studentIds.length) {
                clearInterval(createAllPdfs.getStatusTimer);
                $("#progressIndicator").html("");
                            // zip PDFs and download zipped file
                            window.location = 'zipStudentPdfs.cgi?&remoteUser='+remoteUser+
                                            '&assignmentDir='+semester+'/'+
                                            department+'/'+
                                            course+'/'+
                                            assignment.split(' ')[0]+'/';
            }
        }, 1000);
    }
}
function backToHome(){
        post('loadPage.cgi',{'page':'gradeAnAssignment',
                                'userToken':userToken,
                                'remoteUser':remoteUser,
                                'pagePoints':init.pointValues.toString(),
                                'semester':semester,
                                'department':department,
                                'course':course,
                                'assignment':assignment});
}

function login(){
    $.post("remoteUser.cgi", {}, 
                function (data){
                    console.log(data);
                    login.remoteUser = data['remoteUser'];
                    login.rights= data['rights'];
                    // load setup page
                    post("loadPage.cgi", {'userToken':"",
                                        'page':'startAdmin',
                                        'remoteUser':login.remoteUser});
            });
}

function post(path, params, method) {
    method = method || "post"; // Set method to post by default if not specified.

    // The rest of this code assumes you are not using a library.
    // It can be made less wordy if you use one.
    var form = document.createElement("form");
    form.setAttribute("method", method);
    form.setAttribute("action", path);

    for(var key in params) {
        if(params.hasOwnProperty(key)) {
            var hiddenField = document.createElement("input");
            hiddenField.setAttribute("type", "hidden");
            hiddenField.setAttribute("name", key);
            hiddenField.setAttribute("value", params[key]);

            form.appendChild(hiddenField);
         }
    }

    document.body.appendChild(form);
    form.submit();
}
function newlineList(list){
        listStr = ""
        for (i=0;i<list.length;i++){
                listStr+=list[i]+"\n";
        }
        return listStr
}

function checkRosterNames(){
        $.post("checkRoster.cgi", {'semester':semester,
                                   'department':department,
                                   'classNum':course,
                                   'assignment':assignment.split(' ')[0]}, 
                function (data){
                    //console.log(data);
                    checkRosterNames.notInRoster = data[0]
                    checkRosterNames.notInAssignment = data[1]
                    alert("The following names are in this assignment but not in the roster:\n\n"+
                          newlineList(checkRosterNames.notInRoster)+
                          "\n"+
                          "The following names are in the roster but not in this assignment:\n\n"+
                          newlineList(checkRosterNames.notInAssignment));
            });
}

function gradesArePublished(please_alert) {
        $.post("gradesArePublished.cgi", {'remoteUser':remoteUser,
                                                     'courseLocation':semester+'/'+
                                                        department+'/'+
                                                        course+'/'+
                                                        assignment.split(' ')[0]+'/',
                                                        'unpublish':'No'}, 
                        function (data){
                            console.log(data);
                            if (data == 'true\n') {
                                gradesArePublished.status = true;
                                $("#published").html("(grades have been published)");
                                if (please_alert) alert("The grades have been published.");
                                $("#publishButton").val("Unpublish Grades"); 
                            }
                            else {
                                gradesArePublished.status = false;
                                $("#published").html("(grades have not been published)");
                                if (please_alert) alert("The grades have been unpublished.");
                                $("#publishButton").val("Publish to Students");
                            }
                        });
}
function publishToStudents(){
                        console.log("Publishing grades...");
                        $("#progressIndicator").html("<img src='../data/indicator.gif'>");
                        $.post("publishGrades.cgi", {'remoteUser':remoteUser,
                                                     'courseLocation':semester+'/'+
                                                        department+'/'+
                                                        course+'/'+
                                                        assignment.split(' ')[0]+'/',
                                                        'unpublish':gradesArePublished.status}, 
                        function (data){
                            console.log(data);
                            gradesArePublished(true);
                            $("#progressIndicator").html("");
                        });        
}
function checkIfStudentPDFs() {
        $.post("studentsShownPDFs.cgi", {'remoteUser':remoteUser,
                                                     'courseLocation':semester+'/'+
                                                        department+'/'+
                                                        course+'/'+
                                                        assignment.split(' ')[0]+'/',
                                                        'unpublish':'No'}, 
                        function (data){
                            console.log(data);
                            if (data == 'true\n') {
                                $("#studentPDFsShown").html("(currently, students will not see PDFs)");
                                $("#noStudentPDFs").val("Show PDFs to students");
                                init.showStudentPDFs = false;
                            }
                            else {
                                $("#studentPDFsShown").html("(currently, students will see PDFs)");
                                $("#noStudentPDFs").val("Do not show PDFs to students");
                                init.showStudentPDFs = true;
                            }
                        });
}
function noStudentPDFs(){
        if (init.showStudentPDFs) {
               unpublish = 'No';
        }
        else {
               unpublish = 'Yes';
        }

        console.log("Will unpublish PDFs? "+unpublish);
        $.post("noStudentPDFs.cgi", {'remoteUser':remoteUser,
                                     'courseLocation':semester+'/'+
                                        department+'/'+
                                        course+'/'+
                                        assignment.split(' ')[0]+'/',
                                        'unpublish':unpublish}, 
        function (data){
            console.log(data);
            checkIfStudentPDFs();
        });        
}
function exportToCsv(){
        var csv = $("#pagesTable").table2CSV({
                delivery: 'value'
        });
        // $("#tableCSV").html("<pre>"+csv+"</pre>"); 
        csv.replace(/&nbsp/g,"");
        console.log(csv);
        var filename=semester+"_"+course+"_"+assignment;
        filename = filename.replace(" ","_");
        filename = filename.replace("-","_");
        filename = filename.replace("(","");
        filename = filename.replace(")","");


        download(csv,filename,"text/csv"); 
}

</script>
<body onload="init()">
	<form style="display: hidden;" action="loadPage.cgi" method="POST" id="loadPageForm">
		<input type="hidden" id="pageLoadPage" name="page" value=""/>
		<input type="hidden" id="userTokenLoadPage" name="userToken" value=""/>
		<input type="hidden" id="remoteUserLoadPage" name="remoteUser" value=""/>
		<input type="hidden" id="pageToLoadLoadPage" name="pageToLoad" value=""/>
		<input type="hidden" id="pagePointsLoadPage" name="pagePoints" value=""/>
		<input type="hidden" id="pageNumLoadPage" name="pageNum" value=""/>
		<input type="hidden" id="semesterLoadPage" name="semester" value=""/>
		<input type="hidden" id="departmentLoadPage" name="department" value=""/>
		<input type="hidden" id="courseLoadPage" name="course" value=""/>
		<input type="hidden" id="assignmentLoadPage" name="assignment" value=""/>
		<input type="hidden" id="nextPageTypeLoadPage" name="nextPageType" value=""/>
		<input type="hidden" id="currentGradeLoadPage" name="currentGrade" value=""/>
		<input type="hidden" id="gradeMaxLoadPage" name="gradeMax" value=""/>
        </form>

        <form style="display: hidden;" action="downloadStudentExam.cgi" method="POST" id="downloadStudentExam">
		<input type="hidden" id="remoteUserDownloadExam" name="remoteUser" value=""/>
		<input type="hidden" id="studentDirDownloadExam" name="studentDir" value=""/>
        </form>
    <p style="font-size:20px">
    <b><a href="javascript:login();">Virtual Grade</a></b>
    <p>
    <div id='histogramData' class="graph"></div>
    <span id='selectedCourse'> Selected Course:</span>
    <p>
    <span id='remoteUser'>Grader:<p></span> <span><input type="button" id="backToUserPage" value="Go back to your grade page" onclick="backToHome()"></span><p>
    <b>Assignment Statistics (click on student for full exam, or individual page points for that page, <span style="color:red">incomplete scores in red</span>):</b>
    <p><input type="button" id="createStudentExams" value="Create PDFs for all Students" onclick="createAllPdfs()">
    <input type="button" id="publishButton" value = "Publish to Students" onclick="publishToStudents()"> 
    <span id="published"></span>
    <input type="button" id="noStudentPDFs" value = "Do not show PDFs to Students" onclick="noStudentPDFs()"> 
    <span id="studentPDFsShown"></span>
    <p>
    <input type="button" id="checkAgainstRoster" value="Check names against roster" onclick="checkRosterNames()">
    <input type="button" id="changeBonusPoints" value="Change bonus points" onclick="setBonusPoints(4)">
    (Bonus points: <span id="bonusPointsSpan"></span> 
    <input type="button" id="csvExport" value="Export to CSV" onclick="exportToCsv()">
    <p>
    <span id='progressIndicator'></span>
    <div id='pagesTable'><p></div>
    <p>
    <span id='pdfPagesComplete'><p></span>
    <div id='tableCSV'></div>
</body>
</html>
