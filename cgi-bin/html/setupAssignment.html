<!doctype html>
<html>
<head>
  <!--<link rel="stylesheet" type="text/css" href="grade_a_page.css"> -->
  <title>Virtual Grade</title>
</head>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js" ></script>
<script type="text/javascript">
var userToken = '';
function init(){
}
function setupPagePoints(numPages){
    if (numPages == 0) {
        if ((document.getElementById('dept').value == '') ||
            (document.getElementById('classNum').value == '') ||
            (document.getElementById('assignmentNum').value == '')) {
            alert("Please ensure that Class Department, Class Number, and Assignment Number are filled in.");
            return;
        }
        // check if the assignment already exists
        assignmentNum = document.getElementById('assignmentNum').value;
        if (loadCurrentAssignments.prevAssignmentData != undefined) {
                for (i=0;i<loadCurrentAssignments.prevAssignmentData.length;i++) {
                        if (assignmentNum == loadCurrentAssignments.prevAssignmentData[i]) {
                                alert("Assignment " + assignmentNum +" has already been created! Please choose a different number.");
                                return;
                        }
                }
        }
        numPages = prompt("Number of pages in assignment (0 if unknown) : ", "0");
        setupPagePoints.numPages = numPages;
        if (numPages == 0) { // still zero pages
            savePointValues();
            $("#finishedSettingUpAssignment").html("Your assignment has been set up on the server.");
            return;
        }
    }
    setupPagePoints.numPages = numPages;
    if (setupPagePoints.numPages > 0) {
        jQuery("#pagePointFields").append("Points per page:<p>");
        for (var i=0;i<setupPagePoints.numPages;i++) {
            $("#pagePointFields").append("  Page "+(i+1)+":");
            $("<input class='pageNumField' type='text'/>")
                .attr("id", "pageNumId"+i)
                .attr("name", "page"+i)
                .attr("size", 5)
                .attr("value",0)
                .appendTo("#pagePointFields");
        }
        $("#totalPoints").html("<p style='padding-left:5em'><b>Total Points: 0</b>");
        $("#saveTotalPoints").html("<p style='padding-left:5em'><input type='button' id='savePagePointsButton' value='Save Point Values and Create Assignment on Server' onclick='savePointValues()'>");
        $( ".pageNumField").change(function() {
            var totalPoints=0;
            for(i=0;i<setupPagePoints.numPages;i++) {
                pagePoints = parseInt(document.getElementById('pageNumId'+i).value);
                if (!isNaN(pagePoints)) {
                    totalPoints+=pagePoints;
                }
            }
            $("#totalPoints").html("<p style='padding-left:5em'><b>Total Points: "+totalPoints+"</b>");
        });
    }
}
function savePointValues(){
    // create assignment on server and save the point values to the server for later processing
    // create array of page points
    var pagePointsArray = new Array();
    for (i=0;i<setupPagePoints.numPages;i++){
        pagePointsArray.push(document.getElementById('pageNumId'+i).value);
    }

    $.post( "savePoints.cgi", {'data':JSON.stringify({'department':document.getElementById('dept').value,
                                        'classNum':  document.getElementById('classNum').value,
                                        'assignmentNum':document.getElementById('assignmentNum').value,
                                        'assignmentName':document.getElementById('assignmentName').value,
                                        'pagePoints':pagePointsArray
                                        })}, 
                                       function (data){
        console.log(data);
        assignments = JSON.parse(data);
    });
}

function bubblesOnPDF(){
    //console.log("changed");
    if(document.getElementById('PdfFileChooser').value == '') {
        alert("Please choose a file first.");
        return;
    }
    if ((document.getElementById('dept').value == '') ||
        (document.getElementById('classNum').value == '') ||
        (document.getElementById('assignmentNum').value == '')) {
        alert("Please ensure that Class Department, Class Number, and Assignment Number are filled in.");
        return;
    }
    else {
        // begin upload for processing
        var xhr = new XMLHttpRequest();
        var fd = new FormData();
        fd.append("department", document.getElementById('dept').value);
        fd.append("classNum", document.getElementById('classNum').value);
        fd.append("assignment",document.getElementById('assignmentNum').value);
        fd.append("fileToUpload", document.getElementById('PdfFileChooser').files[0]);
        xhr.open("POST", "uploadPDF.cgi",true);
        xhr.responseType = 'text';
        xhr.onload = function(e) {
            if (this.status == 200) {
                //console.log(this.response);
                returnedText = this.response.split("\n");
                console.log(returnedText);
                bubbleFilename = returnedText[0]
                console.log(bubbleFilename);
                // TODO: Fix this to download automatically instead of a kludgy button
                // See: downloadStudentExam.cgi and fullStats.html
                downloadName = document.getElementById('PdfFileChooser').files[0].name.replace(/(\.[\w\d_-]+)$/i, '_bubbled$1');                 
                $("#downloadBubbledFileSpan").html("<p style='margin-left:15em'><a href='"+bubbleFilename+"' download='"+downloadName+"'target='_blank'>Download Bubbled Assignment within 30 seconds</a>");
                // delete in 30 seconds
                setTimeout(function(){
                                    $("#downloadBubbledFileSpan").html("");
                               }, 30000);
                var xhrDel = new XMLHttpRequest();
                var fdDel = new FormData();
                fdDel.append("filename", bubbleFilename);
                xhrDel.open("POST", "delTempFile.cgi",true);
                xhrDel.responseType = 'text';
                xhrDel.onload = function(e) {
                    if (this.status == 200) {
                        console.log(this.response);
                    }
                }
                xhrDel.send(fdDel);
                setupPagePoints(parseInt(returnedText[1]));
            }
        };
        xhr.send(fd);
    }
}
function login(){
    $.post("remoteUser.cgi", {}, 
                function (data){
                    console.log(data);
                    login.remoteUser = data['remoteUser'];
                    login.rights= data['rights'];
                    if (data.rights.indexOf('admin')!= -1) {
                        // load setup page
                        window.location = 'loadPage.cgi?userToken=""&page=startAdmin'+
                                    '&remoteUser='+login.remoteUser;
                    }
                    else if (data.rights.indexOf('grader') != -1) {
                        // load grading page
                    }
                    else {
                        alert('Unauthorized User. Please see a faculty member for assistance.');
                    }
            });
}
function loadCurrentAssignments(){
	// get class info from checkbox
	classNum = document.getElementById("classNum");

	if (classNum.value=="") return;
	$.post( "getCurrentAssignments.cgi", {'classNum':classNum.value,
					'department':document.getElementById('dept').value
                                        }, 
                                       function (data){
                        loadCurrentAssignments.prevAssignmentData = data;
                        console.log(loadCurrentAssignments.prevAssignmentData);
                        //var s = $('<select />');
			//for(var val in prevAssignmentData) {
			//    $('<option />', {value: val, text: data[val]}).appendTo(s);
			//}
                        var assignmentList = "";
                        for(i=0;i<loadCurrentAssignments.prevAssignmentData.length;i++){
                                assignmentList+=loadCurrentAssignments.prevAssignmentData[i];
                                if (i<loadCurrentAssignments.prevAssignmentData.length-1) {
                                        assignmentList+=", ";
                                }
                        }
	                $("#previousAssignments").html("Previous Assignments: "+assignmentList);
	                //$("#previousAssignments").append(s);

    });
	}
</script>

<body onload="init()">
    <p style="font-size:20px">
    <b><a href="javascript:login();">Virtual Grade</a></b>
    <p>
    Class Department:<input type="text" value="COMP" id="dept" size="10">
    <p>
    Class Number:<input type="text" value="15" id="classNum" size="10" onchange="loadCurrentAssignments()">
    <span id="previousAssignments"></span>
    <p>
    Assignment Number:<input type="text" id="assignmentNum" size="10">
    <p>
    Assignment Name (optional):<input type="text" id="assignmentName" size="10">
    <p>
    <span id="fileChooserSpan"><input type="button" id="bubblesButton" value="Add Bubbles to Test (PDF)" onclick="bubblesOnPDF()"></span>
    <input type="file" id="PdfFileChooser">
    <span id="downloadBubbledFileSpan" ></span>
    <p>
    <input type="button" id="setupButton" value="Setup without Bubbled File" onclick="setupPagePoints(0)"><span id="finishedSettingUpAssignment"></span>
    <div id="pagePointFields">
    <!-- dummy location for page point fields-->
    </div>
    <div id="totalPoints">
    <!-- dummy location for totalPoints field-->
    </div>
    <div id="saveTotalPoints">
    <!-- dummy location for saveTotalPoints button-->
    </div>
</body>
</html>